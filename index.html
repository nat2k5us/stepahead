<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>StepAhead</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '{{PRIMARY_COLOR}}',
                        'primary-dark': '#764ba2'
                    }
                }
            }
        }
    </script>
    <style>
        /* iOS Safe Area Support */
        :root {
            --safe-area-inset-top: env(safe-area-inset-top);
            --safe-area-inset-bottom: env(safe-area-inset-bottom);
        }

        html {
            background: #667eea; /* Fallback for default theme */
            min-height: 100vh;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            min-height: 100vh;
            min-height: -webkit-fill-available;
            width: 100%;
            overflow-x: hidden;
            background: #667eea; /* Fallback color */
            position: relative;
        }

        /* CRITICAL: Remove all default backgrounds */
        * {
            box-sizing: border-box;
        }

        /* Mobile-only styles */
        @media (max-width: 768px) {
            body.app-active {
                overflow: hidden;
                height: 100vh;
                position: fixed;
                width: 100%;
            }

            #mainAppContainer {
                height: 100vh;
                display: flex;
                flex-direction: column;
            }
        }

        /* Mobile Layout - Transparent to show body gradient */
        .mobile-layout {
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            background: transparent !important;
        }

        /* Main app container with full gradient - SAME AS LOGIN SCREEN */
        #mainAppContainer {
            min-height: 100vh;
            width: 100%;
        }

        /* Apply theme gradient to html, body AND main container for COMPLETE coverage */
        html:has(body.theme-default),
        body.theme-default,
        body.theme-default #mainAppContainer {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        html:has(body.theme-ocean),
        body.theme-ocean,
        body.theme-ocean #mainAppContainer {
            background: linear-gradient(135deg, #2E3192 0%, #1BFFFF 100%);
        }
        html:has(body.theme-sunset),
        body.theme-sunset,
        body.theme-sunset #mainAppContainer {
            background: linear-gradient(135deg, #FA8BFF 0%, #2BD2FF 100%);
        }
        html:has(body.theme-forest),
        body.theme-forest,
        body.theme-forest #mainAppContainer {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
        }
        html:has(body.theme-dark),
        body.theme-dark,
        body.theme-dark #mainAppContainer {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }

        .mobile-app-container {
            background: transparent !important;
        }

        .tab-content,
        .tab-content > div,
        .mobile-content {
            background: transparent !important;
        }

        /* FLOATING Header - NO fixed bar, just floating like debug controls */
        .mobile-header {
            position: fixed;
            top: env(safe-area-inset-top);
            left: 0;
            right: 0;
            padding: 1rem;
            color: white;
            font-size: 1.25rem;
            font-weight: bold;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
            z-index: 100;
            pointer-events: none;
            background: transparent;
        }

        .mobile-header > * {
            pointer-events: auto;
        }

        /* Content Area */
        .mobile-content {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 1rem;
            padding-top: calc(3.5rem + env(safe-area-inset-top)); /* Space for floating header */
            padding-bottom: calc(90px + env(safe-area-inset-bottom)); /* Space for floating navbar */
        }

        /* FLOATING Bottom Navigation - Rounded pill floating like debug controls */
        .mobile-bottom-nav {
            position: fixed;
            bottom: calc(6px + env(safe-area-inset-bottom));
            left: 24px;
            right: 24px;
            display: flex !important;
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            padding: 0.5rem 0.25rem;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2);
            z-index: 100;
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.35rem;
            cursor: pointer;
            transition: all 0.3s;
            color: rgba(255, 255, 255, 0.7);
            min-height: 44px;
        }

        .nav-item.active {
            color: white;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 0.5rem;
        }

        .nav-icon {
            font-size: 1.5rem;
            margin-bottom: 0.15rem;
            transition: transform 0.2s;
        }

        .nav-item.active .nav-icon {
            transform: scale(1.05);
        }

        .nav-item > div:not(.nav-icon) {
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        /* Debug Controls - Floating Panel */
        .debug-controls {
            position: fixed;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.85);
            border-radius: 12px;
            padding: 15px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .debug-controls.hidden {
            display: none;
        }

        .debug-btn {
            width: 50px;
            height: 50px;
            background: #667eea;
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .debug-btn:active {
            transform: scale(0.95);
            background: #5a67d8;
        }

        .debug-toggle {
            position: fixed;
            top: 100px;
            right: 10px;
            background: rgba(255, 0, 0, 0.7);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            color: white;
            font-size: 20px;
            cursor: pointer;
            z-index: 10000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .debug-info {
            color: white;
            font-size: 11px;
            text-align: center;
            margin-top: 5px;
            font-family: monospace;
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Login Screen */
        .login-screen {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .login-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 1.5rem;
            padding: 2.5rem;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .login-logo {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .login-title {
            font-size: 2rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 2rem;
        }

        .login-input {
            width: 100%;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            font-size: 1rem;
            transition: all 0.2s;
            background: white;
        }

        .login-input:focus {
            outline: none;
            border-color: {{PRIMARY_COLOR}};
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .login-button {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%);
            color: white;
            border: none;
            border-radius: 0.75rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 1rem;
        }

        .login-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .login-link {
            color: {{PRIMARY_COLOR}};
            text-decoration: none;
            font-weight: 600;
        }

        .error-message {
            background: #fee2e2;
            color: #dc2626;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }

        .hidden {
            display: none !important;
        }

        /* Theme Variables - Default (Purple) */
        body.theme-default {
            --theme-primary: #667eea;
            --theme-secondary: #764ba2;
            --theme-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --theme-light: rgba(102, 126, 234, 0.1);
            --theme-text: #667eea;
        }
        body.theme-ocean {
            --theme-primary: #2E3192;
            --theme-secondary: #1BFFFF;
            --theme-gradient: linear-gradient(135deg, #2E3192 0%, #1BFFFF 100%);
            --theme-light: rgba(27, 255, 255, 0.1);
            --theme-text: #2E3192;
        }
        body.theme-sunset {
            --theme-primary: #FA8BFF;
            --theme-secondary: #2BD2FF;
            --theme-gradient: linear-gradient(135deg, #FA8BFF 0%, #2BD2FF 100%);
            --theme-light: rgba(250, 139, 255, 0.1);
            --theme-text: #FA8BFF;
        }
        body.theme-forest {
            --theme-primary: #56ab2f;
            --theme-secondary: #a8e063;
            --theme-gradient: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
            --theme-light: rgba(86, 171, 47, 0.1);
            --theme-text: #56ab2f;
        }
        body.theme-dark {
            --theme-primary: #1a1a2e;
            --theme-secondary: #16213e;
            --theme-gradient: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            --theme-light: rgba(26, 26, 46, 0.1);
            --theme-text: #1a1a2e;
        }

        /* Apply theme to components */
        .login-screen {
            background: var(--theme-gradient);
        }

        .login-button {
            background: var(--theme-gradient);
        }

        .nav-item.active {
            color: var(--theme-text);
            background: var(--theme-light);
        }

        /* Theme for headings - white on gradient background */
        .tab-content h2,
        .tab-content h3 {
            color: white !important;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            font-weight: 700;
        }

        /* Theme for buttons */
        button.login-button:hover {
            opacity: 0.9;
        }

        /* Theme for active states */
        .nav-icon {
            transition: all 0.3s ease;
        }

        .nav-item.active .nav-icon {
            filter: brightness(1.1);
        }

        /* Theme for links and interactive elements */
        .login-link {
            color: var(--theme-text);
        }

        /* Theme for toggle switches */
        input[type="checkbox"]:checked + div {
            background: var(--theme-primary) !important;
        }

        /* Theme for focus states */
        .login-input:focus {
            border-color: var(--theme-primary);
            box-shadow: 0 0 0 3px var(--theme-light);
        }

        /* Theme for cards with hover effects */
        .bg-white.rounded-xl.shadow {
            transition: box-shadow 0.3s ease, transform 0.2s ease;
        }

        .bg-white.rounded-xl.shadow:hover {
            box-shadow: 0 10px 25px var(--theme-light);
        }

        /* Theme for the selected theme button border */
        .theme-selected {
            border: 3px solid var(--theme-primary) !important;
            box-shadow: 0 0 0 2px var(--theme-light), 0 4px 12px rgba(0,0,0,0.2) !important;
        }

        /* Gradients now applied to #mainAppContainer instead of body */


        /* Theme cards with semi-transparent white/blur */
        .bg-white.rounded-xl,
        .bg-white.rounded-lg {
            background: rgba(255, 255, 255, 0.9) !important;
            backdrop-filter: blur(20px) !important;
            -webkit-backdrop-filter: blur(20px) !important;
        }

        /* All main section headers white on gradient */
        .tab-content h2 {
            color: white !important;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
        }

        /* Card headers stay dark */
        .bg-white h3 {
            color: #1f2937 !important;
            text-shadow: none !important;
        }

        /* Logout button themed */
        .bg-red-500 {
            background: rgba(239, 68, 68, 0.95) !important;
            backdrop-filter: blur(10px);
        }

        /* Theme for text accents */
        .text-purple, .font-bold.text-purple {
            color: var(--theme-text) !important;
        }

        /* Theme for dividers */
        .border-gray-200 {
            border-color: var(--theme-light) !important;
        }

        /* Theme transitions */
        * {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        /* Don't transition positions and transforms */
        .nav-item, .mobile-bottom-nav, .debug-controls {
            transition: background-color 0.3s ease, color 0.3s ease !important;
        }

        /* Theme for Save Changes button */
        button.login-button, .login-button {
            background: var(--theme-gradient);
            border: none;
            box-shadow: 0 4px 12px var(--theme-light);
        }

        button.login-button:active {
            transform: scale(0.98);
            box-shadow: 0 2px 6px var(--theme-light);
        }

        /* Theme for profile display text */
        #profileDisplayName {
            color: #1f2937 !important;
        }

        /* Card headers stay dark for readability on white cards */
        .bg-white h3.text-lg.font-semibold {
            color: #1f2937 !important;
            text-shadow: none;
        }
    </style>
</head>
<body class="theme-default">

    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-container">
            <!-- Logo and Title -->
            <div style="text-align: center;">
                <div class="login-logo">üè†</div>
                <h1 class="login-title">StepAhead</h1>
            </div>

            <!-- Error Message -->
            <div id="errorMessage" class="error-message hidden"></div>

            <!-- Login Form -->
            <div id="loginForm">
                <input type="email" id="loginEmail" placeholder="EMAIL" class="login-input" autocomplete="email">
                <input type="password" id="loginPassword" placeholder="PASSWORD" class="login-input" autocomplete="current-password">
                <button onclick="signIn()" class="login-button">SIGN IN</button>
                <div style="text-align: center; color: #6b7280;">
                    Don't have an account? <a href="#" onclick="showSignup(); return false;" class="login-link">Create one</a>
                </div>
            </div>

            <!-- Signup Form -->
            <div id="signupForm" class="hidden">
                <input type="text" id="signupName" placeholder="FULL NAME" class="login-input" autocomplete="name">
                <input type="email" id="signupEmail" placeholder="EMAIL" class="login-input" autocomplete="email">
                <input type="password" id="signupPassword" placeholder="PASSWORD" class="login-input" autocomplete="new-password">
                <button onclick="signUp()" class="login-button">CREATE ACCOUNT</button>
                <div style="text-align: center; color: #6b7280;">
                    Already have an account? <a href="#" onclick="showLogin(); return false;" class="login-link">Sign in</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="mainAppContainer" class="hidden">
        <!-- Mobile Layout -->
        <div class="mobile-layout">
            <!-- Header -->
            <div class="mobile-header">
                <div class="flex justify-between items-center">
                    <h1 class="text-xl font-bold">StepAhead</h1>
                    <div class="text-sm">
                        Welcome, <span id="userName">User</span>
                    </div>
                </div>
            </div>

            <!-- Content Area -->
            <div class="mobile-content">
                <!-- Tab Content Areas -->
                <div class="tab-content active" id="homeTab">
                    <div class="p-4">
                        <h2 class="text-2xl font-bold mb-4">Home</h2>
                        <div class="bg-white rounded-lg shadow p-6 mb-4">
                            <p class="text-gray-700 mb-4">Welcome to TacoTalk!</p>
                            <p class="text-gray-600">This is your Home tab. Add your custom content here.</p>
                        </div>

                        <!-- Add your custom content for this tab -->
                        <div class="bg-gray-50 rounded-lg p-6">
                            <h3 class="font-semibold mb-2">Getting Started</h3>
                            <ul class="list-disc list-inside text-gray-600 space-y-1">
                                <li>Customize this tab content</li>
                                <li>Add your app features</li>
                                <li>Build something amazing!</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="statsTab">
                    <div class="p-4">
                        <h2 class="text-2xl font-bold mb-4 text-white">üìä Stats & History</h2>
                        <div id="statsContent">
                            <!-- Stats content will be dynamically rendered -->
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="favoritesTab">
                    <div class="p-4">
                        <h2 class="text-2xl font-bold mb-4">Favorites</h2>
                        <div class="bg-white rounded-lg shadow p-6">
                            <p class="text-gray-700">Favorites content goes here.</p>
                            <p class="text-gray-600 mt-2">Build your features in this section.</p>
                        </div>
                        <!-- Add your custom content for this tab -->
                    </div>
                </div>

                <div class="tab-content" id="profileTab">
                    <div class="p-4" style="padding-bottom: 100px;">
                        <!-- Profile Header -->
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-xl font-bold">Profile</h2>
                            <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-lg font-semibold text-sm shadow-lg hover:bg-red-600">
                                Logout
                            </button>
                        </div>

                        <!-- User Info Card -->
                        <div class="bg-white rounded-xl shadow mb-4 p-4">
                            <div class="text-center mb-4">
                                <div class="text-4xl mb-2">üë§</div>
                                <div class="text-xl font-bold text-gray-900" id="profileDisplayName">Developer</div>
                                <div class="text-sm text-gray-600 mt-1" id="profileDisplayEmail">dev@test.local</div>
                            </div>

                            <!-- Editable fields -->
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Display Name</label>
                                <input type="text" id="profileName" class="login-input" placeholder="Your name">
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                <input type="email" id="profileEmail" class="login-input" readonly style="background: #f3f4f6;">
                            </div>
                            <button onclick="saveProfile()" class="login-button">Save Changes</button>
                        </div>

                        <!-- App Settings Card -->
                        <div class="bg-white rounded-xl shadow p-4 mb-4">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">‚öôÔ∏è App Settings</h3>

                            <!-- Theme Selector -->
                            <div class="mb-4">
                                <label class="block text-sm font-semibold text-gray-700 mb-3">üé® Theme</label>
                                <div class="flex justify-center gap-3">
                                    <div onclick="changeTheme('theme-default')" class="cursor-pointer relative" id="theme-default-btn">
                                        <div class="w-12 h-12 rounded-full" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: 3px solid #e5e7eb; box-shadow: 0 2px 8px rgba(0,0,0,0.15);"></div>
                                    </div>
                                    <div onclick="changeTheme('theme-ocean')" class="cursor-pointer relative" id="theme-ocean-btn">
                                        <div class="w-12 h-12 rounded-full" style="background: linear-gradient(135deg, #2E3192 0%, #1BFFFF 100%); border: 3px solid #e5e7eb; box-shadow: 0 2px 8px rgba(0,0,0,0.15);"></div>
                                    </div>
                                    <div onclick="changeTheme('theme-sunset')" class="cursor-pointer relative" id="theme-sunset-btn">
                                        <div class="w-12 h-12 rounded-full" style="background: linear-gradient(135deg, #FA8BFF 0%, #2BD2FF 100%); border: 3px solid #e5e7eb; box-shadow: 0 2px 8px rgba(0,0,0,0.15);"></div>
                                    </div>
                                    <div onclick="changeTheme('theme-forest')" class="cursor-pointer relative" id="theme-forest-btn">
                                        <div class="w-12 h-12 rounded-full" style="background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%); border: 3px solid #e5e7eb; box-shadow: 0 2px 8px rgba(0,0,0,0.15);"></div>
                                    </div>
                                    <div onclick="changeTheme('theme-dark')" class="cursor-pointer relative" id="theme-dark-btn">
                                        <div class="w-12 h-12 rounded-full" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 3px solid #e5e7eb; box-shadow: 0 2px 8px rgba(0,0,0,0.15);"></div>
                                    </div>
                                </div>
                                <p class="text-xs text-gray-600 mt-3 text-center">Choose your app theme</p>
                            </div>

                            <!-- Notifications Toggle -->
                            <div class="mb-4 pt-4 border-t border-gray-200">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700">üîî Notifications</label>
                                        <p class="text-xs text-gray-600 mt-1">Enable push notifications</p>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="notificationsToggle" onchange="toggleNotifications(this.checked)" class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                                    </label>
                                </div>
                            </div>

                            <!-- Dark Mode Toggle -->
                            <div class="mb-4 pt-4 border-t border-gray-200">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700">üåô Dark Mode</label>
                                        <p class="text-xs text-gray-600 mt-1">Use dark theme</p>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode(this.checked)" class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- System Info Card -->
                        <div class="bg-white rounded-xl shadow p-4 mb-4">
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">‚ÑπÔ∏è System Info</h3>
                            <div class="space-y-2 text-sm text-gray-600">
                                <div class="flex justify-between py-2 border-b border-gray-200">
                                    <span>App Version</span>
                                    <span class="font-semibold text-gray-900">1.0.0</span>
                                </div>
                                <div class="flex justify-between py-2 border-b border-gray-200">
                                    <span>Build</span>
                                    <span class="font-semibold text-gray-900">Template v1</span>
                                </div>
                                <div class="flex justify-between py-2">
                                    <span>Platform</span>
                                    <span class="font-semibold text-gray-900" id="platformInfo">iOS</span>
                                </div>
                            </div>
                        </div>

                        <!-- Add your custom profile/settings content -->
                    </div>
                </div>
            </div>

            <!-- Mobile Bottom Navigation -->
            <div class="mobile-bottom-nav">
                <div class="nav-item active" onclick="switchTab('home', this)">
                    <div class="nav-icon">üè†</div>
                    <div>Home</div>
                </div>
                <div class="nav-item" onclick="switchTab('stats', this)">
                    <div class="nav-icon">üìä</div>
                    <div>Stats</div>
                </div>
                <div class="nav-item" onclick="switchTab('favorites', this)">
                    <div class="nav-icon">‚≠ê</div>
                    <div>Favorites</div>
                </div>
                <div class="nav-item" onclick="switchTab('profile', this)">
                    <div class="nav-icon">üë§</div>
                    <div>Profile</div>
                </div>
            </div>
        </div>

        <!-- Debug Controls Toggle Button -->
        <button class="debug-toggle" onclick="toggleDebugControls()">üêõ</button>

        <!-- Debug Controls Panel -->
        <div class="debug-controls hidden" id="debugControls">
            <button class="debug-btn" onclick="moveNavbar('up')">‚¨ÜÔ∏è</button>
            <button class="debug-btn" onclick="moveNavbar('down')">‚¨áÔ∏è</button>
            <button class="debug-btn" onclick="resetNavbar()">‚Ü©Ô∏è</button>
            <div class="debug-info" id="debugInfo">Bottom: 0px</div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

        // Firebase Configuration
        const firebaseConfig = {
          apiKey: "AIzaSyTest123FakeTacoKey456",
          authDomain: "tacotalk-firebase-42.firebaseapp.com",
          projectId: "tacotalk-firebase-42",
          storageBucket: "tacotalk-firebase-42.firebasestorage.app",
          messagingSenderId: "987654321",
          appId: "1:987654321:web:abc123tacotest"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Make functions globally available
        window.auth = auth;
        window.db = db;
        window.doc = doc;
        window.setDoc = setDoc;
        window.getDoc = getDoc;
        window.signOut = signOut;
        window.updateProfile = updateProfile;
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;

        // Auth state listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainAppContainer').classList.remove('hidden');
                document.body.classList.add('app-active');

                // Load user profile
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                const userName = userDoc.exists() ? userDoc.data().displayName : user.email.split('@')[0];
                document.getElementById('userName').textContent = userName;
                document.getElementById('profileName').value = userName;
                document.getElementById('profileEmail').value = user.email;
            } else {
                // User is signed out
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('mainAppContainer').classList.add('hidden');
                document.body.classList.remove('app-active');
            }
        });
    </script>

    <script>
        // STEPAHEAD: Task data structure (full 7 days)
        const tasks = {
          1: [
            {
              name: "Make Your Bed",
              icon: "üõèÔ∏è",
              steps: [
                "Pull the blanket and sheets up to the pillows",
                "Smooth out any wrinkles with your hands",
                "Arrange the pillows at the top",
                "Step back and look - you did it!"
              ],
              stepDurations: [30, 20, 15, 10], // seconds for each step
              color: "#E8F4F8"
            },
            {
              name: "Wash Your Breakfast Dishes",
              icon: "üçΩÔ∏è",
              steps: [
                "Scrape any leftover food into the trash",
                "Turn on warm water",
                "Put dish soap on a sponge",
                "Scrub each dish clean",
                "Rinse with clean water",
                "Place in the dish rack to dry"
              ],
              stepDurations: [20, 10, 15, 60, 30, 20], // seconds for each step
              color: "#FFF4E6"
            },
            {
              name: "Water One Plant",
              icon: "üå±",
              steps: [
                "Get a cup of water",
                "Find one plant in your home",
                "Feel the soil - is it dry?",
                "Slowly pour water until soil is damp",
                "You helped something grow today!"
              ],
              stepDurations: [15, 30, 20, 30, 10], // seconds for each step
              color: "#E8F8F5"
            }
          ],
          2: [
            {
              name: "Make Your Bed",
              icon: "üõèÔ∏è",
              steps: [
                "Pull the blanket and sheets up to the pillows",
                "Smooth out any wrinkles with your hands",
                "Arrange the pillows at the top",
                "Step back and look - you did it!"
              ],
              stepDurations: [30, 20, 15, 10],
              color: "#E8F4F8"
            },
            {
              name: "Take Out the Trash",
              icon: "üóëÔ∏è",
              steps: [
                "Tie the trash bag closed",
                "Lift the bag out of the trash can",
                "Walk to your outside trash bin",
                "Put the bag in the bin",
                "Put a new bag in your trash can",
                "Wash your hands"
              ],
              stepDurations: [15, 20, 30, 10, 15, 20],
              color: "#F0F4FF"
            },
            {
              name: "Wipe the Kitchen Counter",
              icon: "‚ú®",
              steps: [
                "Get a clean cloth or paper towel",
                "Spray cleaner OR wet the cloth with water",
                "Wipe the counter from left to right",
                "Get any crumbs or spills",
                "Look at your clean counter - nice work!"
              ],
              stepDurations: [10, 15, 30, 20, 10],
              color: "#FFF0F5"
            },
            {
              name: "Put Away 5 Things",
              icon: "üì¶",
              steps: [
                "Look around for things that are out of place",
                "Pick up one thing and put it where it belongs",
                "Do this 4 more times (5 things total)",
                "Your space looks better already!"
              ],
              stepDurations: [20, 30, 60, 10],
              color: "#F5F0FF"
            }
          ],
          3: [
            {
              name: "Make Your Bed",
              icon: "üõèÔ∏è",
              steps: [
                "Pull the blanket and sheets up to the pillows",
                "Smooth out any wrinkles with your hands",
                "Arrange the pillows at the top",
                "Step back and look - you did it!"
              ],
              stepDurations: [30, 20, 15, 10],
              color: "#E8F4F8"
            },
            {
              name: "Wash Your Lunch Dishes",
              icon: "üç¥",
              steps: [
                "Scrape any leftover food into the trash",
                "Turn on warm water",
                "Put dish soap on a sponge",
                "Scrub each dish clean",
                "Rinse with clean water",
                "Place in the dish rack to dry"
              ],
              stepDurations: [20, 10, 15, 60, 30, 20],
              color: "#FFF4E6"
            },
            {
              name: "Sweep the Kitchen Floor",
              icon: "üßπ",
              steps: [
                "Get your broom and dustpan",
                "Start in one corner of the kitchen",
                "Sweep dirt into a pile",
                "Use the dustpan to pick up the pile",
                "Put dirt in the trash",
                "Put broom and dustpan away"
              ],
              stepDurations: [15, 20, 45, 20, 15, 10],
              color: "#E8F8F5"
            },
            {
              name: "Sort Your Mail",
              icon: "üìÆ",
              steps: [
                "Get any mail from today",
                "Make 2 piles: important and not important",
                "Put important mail in one spot",
                "Recycle junk mail",
                "You're organized!"
              ],
              stepDurations: [20, 30, 15, 20, 10],
              color: "#F0F4FF"
            },
            {
              name: "Change Your Hand Towel",
              icon: "üß¥",
              steps: [
                "Take the used towel off the rack",
                "Put it in the laundry",
                "Get a clean towel",
                "Hang the clean towel on the rack",
                "Fresh towel ready!"
              ],
              stepDurations: [10, 15, 15, 10, 10],
              color: "#FFF0F5"
            }
          ],
          4: [
            {
              name: "Make Your Bed",
              icon: "üõèÔ∏è",
              steps: [
                "Pull the blanket and sheets up to the pillows",
                "Smooth out any wrinkles with your hands",
                "Arrange the pillows at the top",
                "Step back and look - you did it!"
              ],
              stepDurations: [30, 20, 15, 10], // seconds for each step
              color: "#E8F4F8"
            },
            {
              name: "Empty the Dishwasher",
              icon: "üçΩÔ∏è",
              steps: [
                "Open the dishwasher",
                "Touch a dish - is it dry and cool?",
                "Put away all the plates",
                "Put away all the cups",
                "Put away all the silverware",
                "Put away any other dishes",
                "Close the empty dishwasher"
              ],
              stepDurations: [10, 10, 45, 30, 30, 30, 10],
              color: "#FFF4E6"
            },
            {
              name: "Water Your Plants",
              icon: "üíß",
              steps: [
                "Get your watering can or cup",
                "Fill it with water",
                "Go to each plant",
                "Give each one a drink of water",
                "Plants are happy!"
              ],
              stepDurations: [15, 20, 30, 60, 10],
              color: "#E8F8F5"
            },
            {
              name: "Wipe Down the Bathroom Sink",
              icon: "üö∞",
              steps: [
                "Get a cloth or paper towel",
                "Spray cleaner OR wet with water",
                "Wipe the sink and faucet",
                "Wipe around the sink edges",
                "Throw away paper towel OR rinse cloth",
                "Shiny and clean!"
              ],
              stepDurations: [10, 15, 30, 20, 15, 10],
              color: "#F0F4FF"
            },
            {
              name: "Take Out Recycling",
              icon: "‚ôªÔ∏è",
              steps: [
                "Gather items to recycle",
                "Take them to your recycling bin",
                "Put them in the bin",
                "Put a new bag in if needed",
                "Great job recycling!"
              ],
              stepDurations: [30, 30, 15, 15, 10],
              color: "#FFF0F5"
            },
            {
              name: "Fold 3 Pieces of Laundry",
              icon: "üëï",
              steps: [
                "Find clean laundry that needs folding",
                "Pick one piece and fold it",
                "Do this 2 more times (3 pieces total)",
                "Put folded items away OR in a neat pile",
                "Good work!"
              ],
              stepDurations: [20, 30, 60, 30, 10],
              color: "#F5F0FF"
            }
          ],
          5: [
            {
              name: "Make Your Bed",
              icon: "üõèÔ∏è",
              steps: [
                "Pull the blanket and sheets up to the pillows",
                "Smooth out any wrinkles with your hands",
                "Arrange the pillows at the top",
                "Step back and look - you did it!"
              ],
              stepDurations: [30, 20, 15, 10],
              color: "#E8F4F8"
            },
            {
              name: "Vacuum One Room",
              icon: "üè†",
              steps: [
                "Get the vacuum cleaner",
                "Plug it in",
                "Turn it on",
                "Push it back and forth across the floor",
                "Get the whole room",
                "Turn off and put away vacuum",
                "Room looks great!"
              ],
              stepDurations: [20, 10, 10, 120, 60, 30, 10],
              color: "#FFF4E6"
            },
            {
              name: "Clean the Toilet",
              icon: "üöΩ",
              steps: [
                "Put on gloves if you have them",
                "Squirt toilet cleaner inside the bowl",
                "Use the toilet brush to scrub",
                "Flush the toilet",
                "Wipe the seat with a disinfecting wipe",
                "Throw away wipe and wash hands",
                "Clean toilet!"
              ],
              stepDurations: [15, 15, 45, 10, 30, 20, 10],
              color: "#E8F8F5"
            },
            {
              name: "Organize Your Desk",
              icon: "üìù",
              steps: [
                "Clear everything off your desk",
                "Wipe the desk surface",
                "Put back only what you need",
                "Throw away any trash",
                "Neat desk, clear mind!"
              ],
              stepDurations: [60, 30, 60, 20, 10],
              color: "#F0F4FF"
            },
            {
              name: "Change Your Bedsheets",
              icon: "üõèÔ∏è",
              steps: [
                "Take off all sheets and pillowcases",
                "Put them in the laundry",
                "Get clean sheets",
                "Put the fitted sheet on the mattress",
                "Put the flat sheet on top",
                "Add clean pillowcases",
                "Arrange blanket and pillows",
                "Fresh bed!"
              ],
              stepDurations: [45, 20, 30, 60, 45, 45, 30, 15],
              color: "#FFF0F5"
            },
            {
              name: "Dust 3 Surfaces",
              icon: "‚ú®",
              steps: [
                "Get a dust cloth or duster",
                "Pick one surface (table, shelf, etc)",
                "Wipe off the dust",
                "Do this for 2 more surfaces",
                "Less dust, more fresh air!"
              ],
              stepDurations: [15, 20, 30, 60, 10],
              color: "#F5F0FF"
            },
            {
              name: "Organize One Drawer",
              icon: "üóÑÔ∏è",
              steps: [
                "Pick one drawer to organize",
                "Take everything out",
                "Throw away anything you don't need",
                "Put things back in neat groups",
                "Close the drawer - so organized!"
              ],
              stepDurations: [15, 30, 45, 60, 10],
              color: "#FFFACD"
            }
          ],
          6: [
            {
              name: "Make Your Bed",
              icon: "üõèÔ∏è",
              steps: [
                "Pull the blanket and sheets up to the pillows",
                "Smooth out any wrinkles with your hands",
                "Arrange the pillows at the top",
                "Step back and look - you did it!"
              ],
              stepDurations: [30, 20, 15, 10],
              color: "#E8F4F8"
            },
            {
              name: "Mop the Kitchen Floor",
              icon: "üßΩ",
              steps: [
                "Sweep the floor first if needed",
                "Get your mop and bucket",
                "Fill bucket with water and cleaner",
                "Dip mop in water and squeeze out extra",
                "Mop the floor in sections",
                "Let floor dry",
                "Empty bucket and put mop away",
                "Sparkling floor!"
              ],
              stepDurations: [45, 30, 30, 20, 120, 120, 30, 10],
              color: "#FFF4E6"
            },
            {
              name: "Clean the Microwave",
              icon: "üì¶",
              steps: [
                "Take out the glass plate",
                "Wash the plate with soap and water",
                "Spray inside of microwave with cleaner",
                "Wipe inside with a cloth",
                "Put the clean plate back",
                "Wipe the outside too",
                "Clean microwave!"
              ],
              stepDurations: [10, 45, 15, 45, 10, 30, 10],
              color: "#E8F8F5"
            },
            {
              name: "Wash Your Bathroom Towels",
              icon: "üß∫",
              steps: [
                "Gather all bathroom towels",
                "Put them in the washing machine",
                "Add detergent",
                "Start the wash cycle",
                "When done, put in dryer or hang to dry",
                "Fresh clean towels coming!"
              ],
              stepDurations: [30, 20, 15, 20, 60, 10],
              color: "#F0F4FF"
            },
            {
              name: "Wipe All Door Handles",
              icon: "üö™",
              steps: [
                "Get a disinfecting wipe",
                "Go to each room",
                "Wipe every door handle",
                "Don't forget bathroom and fridge!",
                "Cleaner, healthier home!"
              ],
              stepDurations: [15, 30, 90, 30, 10],
              color: "#FFF0F5"
            },
            {
              name: "Clean Your Bathroom Mirror",
              icon: "ü™û",
              steps: [
                "Get glass cleaner and paper towels",
                "Spray mirror with cleaner",
                "Wipe in circles",
                "Keep wiping until no streaks",
                "Clear reflection!"
              ],
              stepDurations: [15, 10, 30, 30, 10],
              color: "#F5F0FF"
            },
            {
              name: "Organize Under Your Sink",
              icon: "üö∞",
              steps: [
                "Take everything out from under sink",
                "Throw away empty bottles",
                "Wipe the inside of the cabinet",
                "Put things back in groups",
                "Nice and organized!"
              ],
              stepDurations: [45, 30, 30, 60, 10],
              color: "#FFFACD"
            },
            {
              name: "Straighten the Living Room",
              icon: "üõãÔ∏è",
              steps: [
                "Fluff the couch cushions",
                "Fold blankets",
                "Put away any items that don't belong",
                "Arrange decorations nicely",
                "Tidy space!"
              ],
              stepDurations: [20, 30, 60, 30, 10],
              color: "#FFE4E1"
            }
          ],
          7: [
            {
              name: "Make Your Bed",
              icon: "üõèÔ∏è",
              steps: [
                "Pull the blanket and sheets up to the pillows",
                "Smooth out any wrinkles with your hands",
                "Arrange the pillows at the top",
                "Step back and look - you did it!"
              ],
              stepDurations: [30, 20, 15, 10],
              color: "#E8F4F8"
            },
            {
              name: "Deep Clean the Fridge",
              icon: "‚ùÑÔ∏è",
              steps: [
                "Take out all food from one shelf",
                "Check dates - throw away old food",
                "Spray cleaner on shelf",
                "Wipe shelf clean",
                "Put food back",
                "Do this for each shelf",
                "Wipe outside of fridge",
                "Clean fridge!"
              ],
              stepDurations: [60, 45, 20, 45, 30, 180, 60, 10],
              color: "#FFF4E6"
            },
            {
              name: "Vacuum All Rooms",
              icon: "üè°",
              steps: [
                "Get the vacuum cleaner",
                "Start in bedroom",
                "Vacuum entire room",
                "Move to next room",
                "Keep going until all rooms done",
                "Put vacuum away",
                "All rooms clean!"
              ],
              stepDurations: [20, 30, 120, 30, 240, 30, 10],
              color: "#E8F8F5"
            },
            {
              name: "Clean the Bathroom Completely",
              icon: "üõÅ",
              steps: [
                "Clean the toilet (bowl and outside)",
                "Clean the sink and counter",
                "Clean the mirror",
                "Clean the tub or shower",
                "Sweep and mop the floor",
                "Put out fresh towels",
                "Empty trash",
                "Bathroom sparkles!"
              ],
              stepDurations: [90, 60, 45, 120, 90, 30, 20, 10],
              color: "#F0F4FF"
            },
            {
              name: "Dust Everything",
              icon: "üåü",
              steps: [
                "Get your duster or cloth",
                "Dust all surfaces in living room",
                "Dust all surfaces in bedroom",
                "Don't forget shelves and electronics",
                "Dust light fixtures",
                "So much cleaner!"
              ],
              stepDurations: [15, 90, 90, 60, 45, 10],
              color: "#FFF0F5"
            },
            {
              name: "Do a Load of Laundry",
              icon: "üëî",
              steps: [
                "Gather dirty clothes",
                "Sort by colors if needed",
                "Put clothes in washing machine",
                "Add detergent",
                "Start the wash",
                "When done, move to dryer or hang",
                "Fold when dry",
                "Put away clothes",
                "Laundry complete!"
              ],
              stepDurations: [60, 45, 30, 15, 20, 60, 120, 90, 10],
              color: "#F5F0FF"
            },
            {
              name: "Clean All Windows",
              icon: "ü™ü",
              steps: [
                "Get glass cleaner and paper towels",
                "Spray one window",
                "Wipe clean in circles",
                "Check for streaks",
                "Move to next window",
                "Do all windows in home",
                "See the world clearly!"
              ],
              stepDurations: [20, 15, 45, 20, 15, 180, 10],
              color: "#FFFACD"
            },
            {
              name: "Organize Your Closet",
              icon: "üëó",
              steps: [
                "Take out clothes you don't wear",
                "Put them in a donation bag",
                "Hang up clothes neatly",
                "Fold items on shelves",
                "Line up shoes",
                "Step back and admire your organized closet!"
              ],
              stepDurations: [120, 60, 90, 90, 45, 15],
              color: "#FFE4E1"
            },
            {
              name: "Take Out All Trash and Recycling",
              icon: "üóëÔ∏è",
              steps: [
                "Go to each room with trash",
                "Take out all trash bags",
                "Take them to outside bins",
                "Put new bags in all trash cans",
                "Gather all recycling",
                "Take to recycling bin",
                "All fresh bags!"
              ],
              stepDurations: [60, 60, 45, 60, 45, 30, 10],
              color: "#E0FFFF"
            }
          ]
        };
        console.log('‚úÖ Task data loaded:', Object.keys(tasks).length, 'days');

        // STEPAHEAD: Navigation state
        let currentView = 'home'; // 'home' or 'task'
        let currentTask = null;
        let currentStepIndex = 0;
        let timerInterval = null;
        let timeRemaining = 0;
        let repeatCount = 0; // Track how many times user asked to repeat
        let isListening = false;

        // STEPAHEAD: Task completion tracking with comprehensive metrics
        let taskCompletions = {}; // {day_taskIndex: count}
        let completionHistory = []; // Array of all completion records with full metrics
        let dailyStats = {}; // {date: {completions: n, totalScore: n, totalTime: n}}
        let taskBestScores = {}; // {day_taskIndex: {score: n, date: string}}
        let currentStreak = 0;
        let longestStreak = 0;

        // STEPAHEAD: Format time as MM:SS with negative sign
        function formatTime(seconds) {
            const isNegative = seconds < 0;
            const absSeconds = Math.abs(seconds);
            const mins = Math.floor(absSeconds / 60);
            const secs = absSeconds % 60;
            const formatted = `${mins}:${secs.toString().padStart(2, '0')}`;
            return isNegative ? `-${formatted}` : formatted;
        }

        // STEPAHEAD: Voice command recognition (using Web Speech API for reliability)
        let recognition = null;

        function startVoiceRecognition() {
            if (isListening) return;

            try {
                // Use Web Speech API (works on iOS Safari/WebView)
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

                if (!SpeechRecognition) {
                    console.log('‚ùå Speech recognition not supported');
                    console.log('Platform:', navigator.platform);
                    console.log('UserAgent:', navigator.userAgent);
                    return;
                }

                console.log('‚úÖ SpeechRecognition available:', SpeechRecognition);

                recognition = new SpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = 'en-US';

                console.log('üé§ Recognition object created:', recognition);
                console.log('üé§ Continuous:', recognition.continuous);
                console.log('üé§ InterimResults:', recognition.interimResults);
                console.log('üé§ Lang:', recognition.lang);

                recognition.onstart = () => {
                    isListening = true;
                    console.log('üé§ Voice recognition started (onstart fired)');
                };

                recognition.onresult = (event) => {
                    console.log('üé§ onresult fired, event:', event);
                    console.log('üé§ Results length:', event.results.length);

                    const last = event.results.length - 1;
                    const result = event.results[last];
                    const text = result[0].transcript;
                    const isFinal = result.isFinal;

                    console.log('üé§ Heard:', text, '(final:', isFinal + ')');
                    console.log('üé§ Confidence:', result[0].confidence);

                    // Only process final results to avoid duplicates
                    if (isFinal) {
                        handleVoiceCommand(text);
                    }
                };

                recognition.onerror = (event) => {
                    console.error('‚ùå Voice recognition error:', event.error);
                    console.error('‚ùå Error message:', event.message);
                    if (event.error === 'no-speech') {
                        // Restart if no speech detected
                        setTimeout(() => {
                            if (currentView === 'task' && !isListening) {
                                startVoiceRecognition();
                            }
                        }, 1000);
                    }
                };

                recognition.onend = () => {
                    isListening = false;
                    console.log('üé§ Voice recognition ended');
                    // Auto-restart if still in task view
                    setTimeout(() => {
                        if (currentView === 'task' && !isListening) {
                            console.log('üé§ Auto-restarting...');
                            startVoiceRecognition();
                        }
                    }, 500);
                };

                recognition.start();
                console.log('üé§ .start() called, waiting for onstart event...');

            } catch (error) {
                console.error('‚ùå Voice recognition error:', error);
                console.error('‚ùå Error stack:', error.stack);
                isListening = false;
            }
        }

        function stopVoiceRecognition() {
            if (!isListening || !recognition) return;

            try {
                recognition.stop();
                recognition = null;
                isListening = false;
                console.log('üé§ Voice recognition stopped');
            } catch (error) {
                console.error('‚ùå Error stopping voice recognition:', error);
            }
        }

        // STEPAHEAD: Handle voice commands
        function handleVoiceCommand(text) {
            if (!text) return;

            const command = text.toLowerCase().trim();
            console.log('üé§ Processing command:', command);

            // Next/OK/Done - move to next step
            if (command.includes('next') || command.includes('ok') || command.includes('done')) {
                console.log('‚úÖ Command: Next Step');
                nextStep();
            }
            // Repeat - announce again and reset timer
            else if (command.includes('repeat') || command.includes('again')) {
                console.log('üîÅ Command: Repeat');
                repeatStep();
            }
            // Break it down - more detailed explanation
            else if (command.includes('break it down') || command.includes('break down')) {
                console.log('üìù Command: Break It Down');
                breakDownStep();
            }
        }

        // STEPAHEAD: Repeat current step
        function repeatStep() {
            repeatCount++;
            console.log('üîÅ Repeat count:', repeatCount);

            // Reset timer to original duration
            const task = currentTask.task;
            const stepIndex = currentStepIndex;
            const hasTimer = task.stepDurations && task.stepDurations[stepIndex];

            if (hasTimer) {
                stopTimer();
                timeRemaining = task.stepDurations[stepIndex];
                startTimer();
            }

            // Announce step again
            const currentStep = task.steps[stepIndex];
            announceStep(currentStep);

            // Re-render to update display
            renderStepView();
        }

        // STEPAHEAD: Break down step into more detail
        function breakDownStep() {
            const task = currentTask.task;
            const currentStep = task.steps[currentStepIndex];

            // Generate more detailed breakdown
            const breakdown = generateStepBreakdown(currentStep);

            // Reset timer
            const stepIndex = currentStepIndex;
            const hasTimer = task.stepDurations && task.stepDurations[stepIndex];
            if (hasTimer) {
                stopTimer();
                timeRemaining = task.stepDurations[stepIndex];
                startTimer();
            }

            // Announce detailed breakdown only
            announceStep(breakdown);
            console.log('üîä Breaking down step:', breakdown);
        }

        // STEPAHEAD: Generate detailed breakdown of step
        function generateStepBreakdown(step) {
            // Simple breakdown - add more context and detail
            const breakdowns = {
                'Pull the blanket and sheets up to the pillows': 'Start at the bottom of the bed. Grab the edge of the blanket with both hands. Slowly pull it up toward the pillows. Make sure it covers the whole bed.',
                'Smooth out any wrinkles with your hands': 'Use your hands like an iron. Start from the top and move down. Press firmly to remove bumps and wrinkles. Make the surface flat and even.',
                'Arrange the pillows at the top': 'Pick up each pillow. Fluff it by hitting it gently. Place it at the head of the bed. Line them up nicely in a row.',
                'Step back and look - you did it!': 'Take a few steps backward. Look at your work. The bed should look neat and tidy. Great job completing this task!'
            };

            return breakdowns[step] || `Let me explain: ${step}. Take your time and do one part at a time.`;
        }

        // STEPAHEAD: Show task step-by-step view with timer
        function showTaskView(day, taskIndex) {
            console.log('üìã showTaskView called:', day, taskIndex);

            const homeTab = document.getElementById('homeTab');
            if (!homeTab) return;

            const task = tasks[day][taskIndex];
            currentTask = { day, taskIndex, task };
            currentView = 'task';
            currentStepIndex = 0;
            repeatCount = 0; // Reset repeat counter

            renderStepView();

            // Start voice recognition
            startVoiceRecognition();
        }

        // STEPAHEAD: Render current step with timer
        function renderStepView() {
            const homeTab = document.getElementById('homeTab');
            if (!homeTab || !currentTask) return;

            const task = currentTask.task;
            const stepIndex = currentStepIndex;
            const totalSteps = task.steps.length;
            const currentStep = task.steps[stepIndex];

            // Check if this task has stepDurations
            const hasTimer = task.stepDurations && task.stepDurations[stepIndex];
            const duration = hasTimer ? task.stepDurations[stepIndex] : 0;

            // Initialize timer if not started
            if (timeRemaining === 0 && hasTimer) {
                timeRemaining = duration;
                console.log('‚è∞ Starting timer for', duration, 'seconds');
                startTimer();
                // Announce the step
                announceStep(currentStep);
            }

            const html = `
                <div class="p-4">
                    <!-- Back button -->
                    <button onclick="exitTaskView()" class="flex items-center justify-center gap-2 mb-4 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 font-semibold shadow-md transition-colors">
                        <span>‚Üê</span>
                        <span>Back to Tasks</span>
                    </button>

                    <!-- Task header and timer cards -->
                    <div class="flex gap-3 mb-4">
                        <!-- Task title card -->
                        <div class="flex-1 bg-white rounded-lg shadow-lg p-6 flex items-center gap-3">
                            <span class="text-4xl">${task.icon}</span>
                            <h2 class="text-2xl font-bold text-black">${task.name}</h2>
                        </div>

                        ${hasTimer ? `
                            <!-- Timer card -->
                            <div class="flex-shrink-0 bg-white rounded-lg shadow-lg p-6 flex items-center justify-center min-w-[180px] ${timeRemaining < 0 ? 'bg-red-50' : 'bg-blue-50'} border-4 ${timeRemaining < 0 ? 'border-red-500' : timeRemaining <= 5 ? 'border-red-400' : 'border-blue-500'}">
                                <div id="timerDisplay" class="text-6xl font-bold ${timeRemaining < 0 ? 'text-red-600' : timeRemaining <= 5 ? 'text-red-500' : 'text-blue-600'}">
                                    ${formatTime(timeRemaining)}
                                </div>
                            </div>
                        ` : ''}
                    </div>

                    <!-- Step image (for Make Your Bed only) -->
                    ${task.name === 'Make Your Bed' ? `
                        <div class="mb-4 rounded-lg overflow-hidden shadow-lg">
                            <img src="assets/images/make-bed.png" alt="Making the bed" class="w-full h-32 object-cover">
                        </div>
                    ` : ''}

                    <!-- Current step card -->
                    <div class="bg-white rounded-lg shadow-lg p-8 mb-4">
                        <p class="text-2xl text-gray-800 leading-relaxed text-center font-semibold">${currentStep}</p>
                        <p class="text-lg text-gray-600 leading-relaxed text-center italic mt-4">${generateStepBreakdown(currentStep)}</p>

                        <!-- Voice shortcuts -->
                        <div class="mt-6 pt-4 border-t border-gray-200">
                            <div class="flex flex-wrap justify-center gap-2">
                                <span class="px-3 py-1 bg-blue-50 text-blue-700 rounded-full text-xs font-medium">Say "Next" / "OK" / "Done"</span>
                                <span class="px-3 py-1 bg-purple-50 text-purple-700 rounded-full text-xs font-medium">Say "Repeat" / "Again"</span>
                                <span class="px-3 py-1 bg-green-50 text-green-700 rounded-full text-xs font-medium">Say "Break it down"</span>
                            </div>
                        </div>
                    </div>

                    <!-- Step indicators (numbered circles) -->
                    <div class="flex justify-center gap-2 mb-6">
                        ${Array.from({length: totalSteps}, (_, i) => `
                            <div class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm ${
                                i === stepIndex
                                    ? 'bg-blue-500 text-white scale-110'
                                    : i < stepIndex
                                        ? 'bg-green-500 text-white'
                                        : 'bg-gray-200 text-gray-500'
                            }">
                                ${i < stepIndex ? '‚úì' : i + 1}
                            </div>
                        `).join('')}
                    </div>

                    <!-- Navigation buttons -->
                    <div class="space-y-3">
                        ${stepIndex < totalSteps - 1 ? `
                            <button onclick="nextStep()" class="w-full bg-blue-500 text-white font-bold py-4 rounded-lg hover:bg-blue-600">
                                Next Step ‚Üí
                            </button>
                        ` : `
                            <button onclick="completeTask()" class="w-full bg-green-500 text-white font-bold py-4 rounded-lg hover:bg-green-600">
                                ‚úì Complete Task
                            </button>
                        `}
                        ${stepIndex > 0 ? `
                            <button onclick="previousStep()" class="w-full bg-gray-300 text-gray-700 font-bold py-3 rounded-lg hover:bg-gray-400">
                                ‚Üê Previous Step
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;

            homeTab.innerHTML = html;
            console.log('‚úÖ Step view rendered, step', stepIndex + 1, 'of', totalSteps, 'hasTimer:', hasTimer);
        }

        // STEPAHEAD: Announce step using Text-to-Speech
        function announceStep(stepText) {
            if ('speechSynthesis' in window) {
                // Cancel any ongoing speech
                window.speechSynthesis.cancel();

                const utterance = new SpeechSynthesisUtterance(stepText);
                utterance.rate = 0.9; // Slightly slower for clarity
                utterance.pitch = 1.0;
                utterance.volume = 1.0;

                window.speechSynthesis.speak(utterance);
                console.log('üîä Announcing:', stepText);
            } else {
                console.log('‚ùå Speech synthesis not supported');
            }
        }

        // STEPAHEAD: Timer functions
        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);

            timerInterval = setInterval(() => {
                timeRemaining--;

                // Update timer display with MM:SS format
                const timerDisplay = document.getElementById('timerDisplay');
                if (timerDisplay) {
                    timerDisplay.textContent = formatTime(timeRemaining);

                    // Change color based on time
                    if (timeRemaining < 0) {
                        // Overtime - red
                        timerDisplay.classList.remove('text-blue-500', 'text-blue-600', 'text-red-500');
                        timerDisplay.classList.add('text-red-600');
                    } else if (timeRemaining <= 5) {
                        // Warning - red
                        timerDisplay.classList.remove('text-blue-500', 'text-blue-600');
                        timerDisplay.classList.add('text-red-500');
                    }
                }

                // Never stop - let it go negative
                // Timer continues indefinitely until user clicks Next Step
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            timeRemaining = 0;
        }

        // STEPAHEAD: Step navigation
        function nextStep() {
            stopTimer();
            currentStepIndex++;
            renderStepView();
        }

        function previousStep() {
            stopTimer();
            currentStepIndex--;
            renderStepView();
        }

        function completeTask() {
            stopTimer();
            stopVoiceRecognition();

            const taskKey = `${currentTask.day}_${currentTask.taskIndex}`;
            const score = calculateScore();
            const now = new Date();
            const dateString = now.toLocaleDateString('en-US');

            // Calculate expected vs actual time
            const expectedTime = currentTask.task.stepDurations ?
                currentTask.task.stepDurations.reduce((a, b) => a + b, 0) : 0;
            const actualTime = expectedTime - timeRemaining;
            const wasOnTime = timeRemaining >= 0;
            const hadNoRepeats = repeatCount === 0;
            const perfectScore = score === 100;

            // Track completion count
            if (!taskCompletions[taskKey]) {
                taskCompletions[taskKey] = 0;
            }
            taskCompletions[taskKey]++;

            // Update best score for this task
            if (!taskBestScores[taskKey] || score > taskBestScores[taskKey].score) {
                taskBestScores[taskKey] = {
                    score: score,
                    date: dateString,
                    time: actualTime
                };
            }

            // Comprehensive completion record
            const completionData = {
                taskName: currentTask.task.name,
                day: currentTask.day,
                taskIndex: currentTask.taskIndex,
                taskKey: taskKey,
                completedAt: now.toISOString(),
                date: dateString,
                time: now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }),

                // Time metrics
                expectedTime: expectedTime,
                actualTime: actualTime,
                timeRemaining: timeRemaining,
                wasOnTime: wasOnTime,
                overtimeSeconds: wasOnTime ? 0 : Math.abs(timeRemaining),

                // Performance metrics
                score: score,
                repeatCount: repeatCount,
                hadNoRepeats: hadNoRepeats,
                perfectScore: perfectScore,

                // Excellence badges
                badges: getBadges(score, wasOnTime, hadNoRepeats, perfectScore)
            };

            // Add to history
            completionHistory.push(completionData);

            // Update daily stats
            if (!dailyStats[dateString]) {
                dailyStats[dateString] = {
                    completions: 0,
                    totalScore: 0,
                    totalTime: 0,
                    perfectScores: 0,
                    onTimeCount: 0
                };
            }
            dailyStats[dateString].completions++;
            dailyStats[dateString].totalScore += score;
            dailyStats[dateString].totalTime += actualTime;
            if (perfectScore) dailyStats[dateString].perfectScores++;
            if (wasOnTime) dailyStats[dateString].onTimeCount++;

            // Update streaks
            updateStreaks();

            // Announce score with voice
            announceScore(score, completionData.badges);

            console.log('‚úÖ Task completed:', taskKey, 'Score:', score, 'Badges:', completionData.badges);
            console.log('üìä Full metrics:', completionData);

            // Show home after a brief delay for announcement
            setTimeout(() => {
                showHomeView();
            }, 1000);
        }

        // STEPAHEAD: Calculate score based on performance
        function calculateScore() {
            let score = 100;

            // Deduct points for going overtime
            if (timeRemaining < 0) {
                score -= Math.abs(timeRemaining); // 1 point per second overtime
            }

            // Deduct points for repeating steps
            score -= (repeatCount * 5); // 5 points per repeat

            return Math.max(0, score); // Don't go below 0
        }

        // STEPAHEAD: Get excellence badges based on performance
        function getBadges(score, wasOnTime, hadNoRepeats, perfectScore) {
            const badges = [];

            if (perfectScore) {
                badges.push({ emoji: 'üíé', name: 'Perfect', description: 'Flawless execution!' });
            } else if (score >= 90) {
                badges.push({ emoji: 'ü™ô', name: 'Gold', description: 'Excellent work!' });
            } else if (score >= 75) {
                badges.push({ emoji: 'ü•à', name: 'Silver', description: 'Great job!' });
            }

            if (wasOnTime && score >= 80) {
                badges.push({ emoji: '‚ö°', name: 'Speedy', description: 'Beat the clock!' });
            }

            if (hadNoRepeats && score >= 80) {
                badges.push({ emoji: 'üéØ', name: 'Focused', description: 'No repeats needed!' });
            }

            if (score >= 85 && wasOnTime && hadNoRepeats) {
                badges.push({ emoji: 'üöÄ', name: 'Pro', description: 'Expert performance!' });
            }

            return badges;
        }

        // STEPAHEAD: Announce score with voice
        function announceScore(score, badges) {
            const utterance = new SpeechSynthesisUtterance();

            let message = `Task complete! Your score is ${score}`;

            if (badges.length > 0) {
                message += '. You earned: ';
                message += badges.map(b => b.name).join(', ');
            }

            if (score === 100) {
                message += '. Perfect score!';
            } else if (score >= 90) {
                message += '. Excellent!';
            } else if (score >= 75) {
                message += '. Great work!';
            }

            utterance.text = message;
            utterance.rate = 1.0;
            utterance.pitch = 1.0;

            window.speechSynthesis.speak(utterance);
        }

        // STEPAHEAD: Update completion streaks
        function updateStreaks() {
            const dates = Object.keys(dailyStats).sort();
            if (dates.length === 0) return;

            const today = new Date().toLocaleDateString('en-US');

            // Calculate current streak
            let streak = 0;
            const tempDate = new Date();

            for (let i = 0; i < 365; i++) {
                const checkDate = tempDate.toLocaleDateString('en-US');
                if (dailyStats[checkDate] && dailyStats[checkDate].completions > 0) {
                    streak++;
                    tempDate.setDate(tempDate.getDate() - 1);
                } else {
                    break;
                }
            }

            currentStreak = streak;
            if (currentStreak > longestStreak) {
                longestStreak = currentStreak;
            }
        }

        function exitTaskView() {
            stopTimer();
            stopVoiceRecognition();
            showHomeView();
        }

        // STEPAHEAD: Show home view (task list)
        function showHomeView() {
            console.log('üè† showHomeView called');
            currentView = 'home';
            currentTask = null;
            stopVoiceRecognition(); // Ensure voice recognition stopped

            // Ensure home tab is active and visible
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            const homeTab = document.getElementById('homeTab');
            if (homeTab) {
                homeTab.classList.add('active');
            }

            // Set home nav as active
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            const homeNav = document.querySelector('.nav-item[onclick*="home"]');
            if (homeNav) {
                homeNav.classList.add('active');
            }

            renderHomeTab();
        }

        // STEPAHEAD: Show tasks for a specific day
        function showDayTasks(day) {
            console.log('üìÖ showDayTasks called for day', day);

            const homeTab = document.getElementById('homeTab');
            if (!homeTab) return;

            const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const dayTasks = tasks[day];

            // Calculate if this day is today
            const now = new Date();
            const currentDay = now.getDay() === 0 ? 7 : now.getDay();
            const isToday = parseInt(day) === currentDay;

            // Helper to get date for day
            const dayDiff = parseInt(day) - currentDay;
            const dayDate = new Date(now);
            dayDate.setDate(dayDate.getDate() + dayDiff);
            const formattedDate = `${monthNames[dayDate.getMonth()]} ${dayDate.getDate()}`;

            const html = `
                <div class="p-4 space-y-4">
                    <!-- Back button -->
                    <button onclick="showHomeView()" class="flex items-center justify-center gap-2 mb-4 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 font-semibold shadow-md transition-colors">
                        <span>‚Üê</span>
                        <span>Back to All Days</span>
                    </button>

                    <!-- Day's tasks -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-bold text-xl">${dayNames[day - 1]}</h3>
                            <span class="text-sm font-semibold text-blue-600">${formattedDate}</span>
                        </div>
                        ${!isToday ? `
                            <div class="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-sm text-yellow-800">
                                ‚ö†Ô∏è You can only complete tasks for today
                            </div>
                        ` : ''}
                        <div class="space-y-2">
                            ${dayTasks.map((task, index) => {
                                const taskKey = `${day}_${index}`;
                                const completionCount = taskCompletions[taskKey] || 0;
                                const showCompletions = completionCount >= 1;
                                return `
                                <div onclick="${isToday ? `showTaskView(${day}, ${index})` : ''}" class="flex items-center gap-3 p-3 bg-gray-50 rounded ${isToday ? 'hover:bg-gray-100 cursor-pointer' : 'opacity-50 cursor-not-allowed'}">
                                    <span class="text-2xl">${task.icon}</span>
                                    <div class="flex-1">
                                        <div class="font-semibold">${task.name}</div>
                                        <div class="flex items-center gap-2">
                                            <span class="text-sm text-gray-600">${task.steps.length} steps</span>
                                            ${showCompletions ? `
                                                <span class="px-2 py-0.5 bg-green-100 text-green-700 text-xs font-bold rounded border border-green-300">x${completionCount}</span>
                                            ` : ''}
                                        </div>
                                    </div>
                                    ${isToday ? '<div class="text-gray-400">‚Üí</div>' : ''}
                                </div>
                            `}).join('')}
                        </div>
                    </div>
                </div>
            `;

            homeTab.innerHTML = html;
        }

        // STEPAHEAD: Render function to display all 7 days of tasks
        function renderHomeTab() {
            console.log('üè† renderHomeTab called');

            const homeTab = document.getElementById('homeTab');
            if (!homeTab) {
                console.error('‚ùå homeTab not found');
                return;
            }

            const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            const dayShortNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

            const now = new Date();
            const today = now.getDay(); // 0 = Sunday, 1 = Monday, etc
            const todayIndex = today === 0 ? 7 : today; // Convert Sunday from 0 to 7

            // Helper function to get date for a given day index
            function getDateForDay(dayIndex) {
                const currentDay = now.getDay() === 0 ? 7 : now.getDay();
                const dayDiff = dayIndex - currentDay;
                const date = new Date(now);
                date.setDate(date.getDate() + dayDiff);
                return date;
            }

            // Format date as "Oct 23"
            function formatDate(date) {
                return `${monthNames[date.getMonth()]} ${date.getDate()}`;
            }

            // Separate today's tasks from other days
            const todayTasks = tasks[todayIndex];
            const otherDays = Object.keys(tasks).filter(day => parseInt(day) !== todayIndex);

            const html = `
                <div class="p-4 space-y-4">
                    <h2 class="text-2xl font-bold mb-4">üìÖ My Tasks</h2>

                    <!-- Today's large card -->
                    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-bold text-xl">Today - ${dayNames[todayIndex - 1]}</h3>
                            <span class="text-sm font-semibold text-blue-600">${formatDate(now)}</span>
                        </div>
                        <div class="space-y-2">
                            ${todayTasks.map((task, index) => {
                                const taskKey = `${todayIndex}_${index}`;
                                const completionCount = taskCompletions[taskKey] || 0;
                                const showCompletions = completionCount >= 1;

                                // Get last completion for this task today
                                const dateString = now.toLocaleDateString('en-US');
                                const todayCompletions = completionHistory.filter(c =>
                                    c.taskKey === taskKey && c.date === dateString
                                );
                                const lastCompletion = todayCompletions.length > 0 ?
                                    todayCompletions[todayCompletions.length - 1] : null;

                                return `
                                <div onclick="showTaskView(${todayIndex}, ${index})" class="flex items-center gap-3 p-3 bg-gray-50 rounded hover:bg-gray-100 cursor-pointer">
                                    <span class="text-2xl">${task.icon}</span>
                                    <div class="flex-1">
                                        <div class="font-semibold">${task.name}</div>
                                        <div class="flex items-center gap-2 flex-wrap">
                                            <span class="text-sm text-gray-600">${task.steps.length} steps</span>
                                            ${showCompletions ? `
                                                <span class="px-2 py-0.5 bg-green-100 text-green-700 text-xs font-bold rounded border border-green-300">x${completionCount}</span>
                                            ` : ''}
                                            ${lastCompletion ? `
                                                <span class="px-2 py-0.5 bg-blue-100 text-blue-700 text-xs font-bold rounded border border-blue-300">${lastCompletion.score}</span>
                                                ${lastCompletion.badges.map(badge => `<span class="text-sm">${badge.emoji}</span>`).join('')}
                                            ` : ''}
                                        </div>
                                    </div>
                                    <div class="text-gray-400">‚Üí</div>
                                </div>
                            `}).join('')}
                        </div>
                    </div>

                    <!-- Other days as horizontal scrollable squares -->
                    <div>
                        <h4 class="font-semibold text-sm text-gray-600 mb-2">Other Days</h4>
                        <div class="flex gap-3 overflow-x-auto pb-2">
                            ${otherDays.map(day => {
                                const dayDate = getDateForDay(parseInt(day));
                                const isPast = dayDate < now && dayDate.toDateString() !== now.toDateString();

                                return `
                                <div onclick="showDayTasks(${day})" class="bg-white rounded-lg shadow p-4 flex-shrink-0 cursor-pointer hover:bg-gray-50" style="width: 110px; height: 110px;">
                                    <div class="flex flex-col items-center justify-center h-full text-center">
                                        <h3 class="font-semibold text-sm mb-1 ${isPast ? 'text-gray-400' : ''}">${dayShortNames[day - 1]}</h3>
                                        <div class="text-lg font-bold ${isPast ? 'text-gray-400' : 'text-blue-600'}">${formatDate(dayDate)}</div>
                                        <div class="text-xs ${isPast ? 'text-gray-400' : 'text-gray-500'} mt-1">${tasks[day].length} tasks</div>
                                    </div>
                                </div>
                            `}).join('')}
                        </div>
                    </div>
                </div>
            `;

            homeTab.innerHTML = html;
            console.log('‚úÖ Home tab rendered with', Object.keys(tasks).length, 'days, today is day', todayIndex);
        }

        // Call renderHomeTab when app loads
        window.addEventListener('load', () => {
            console.log('üåç Window loaded, calling renderHomeTab');
            renderHomeTab();
        });

        // Tab switching
        function switchTab(tabId, element) {
            // Remove active class from all nav items
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));

            // Add active class to clicked item
            element.classList.add('active');

            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // Show selected tab content
            document.getElementById(tabId + 'Tab').classList.add('active');

            // If switching to stats tab, render stats
            if (tabId === 'stats') {
                renderStatsTab();
            }
        }

        // STEPAHEAD: Render Stats/History tab
        function renderStatsTab() {
            const statsContent = document.getElementById('statsContent');
            if (!statsContent) return;

            const today = new Date().toLocaleDateString('en-US');
            const todayStats = dailyStats[today] || { completions: 0, totalScore: 0, totalTime: 0, perfectScores: 0, onTimeCount: 0 };

            // Calculate overall stats
            const totalCompletions = completionHistory.length;
            const avgScore = totalCompletions > 0 ? Math.round(completionHistory.reduce((sum, c) => sum + c.score, 0) / totalCompletions) : 0;
            const perfectScoreCount = completionHistory.filter(c => c.perfectScore).length;
            const totalTime = completionHistory.reduce((sum, c) => sum + c.actualTime, 0);

            // Get recent completions
            const recentCompletions = completionHistory.slice(-10).reverse();

            const html = `
                <!-- Daily Overview -->
                <div class="bg-white rounded-lg shadow-lg p-6 mb-4">
                    <h3 class="font-bold text-lg mb-4">üìÖ Today's Performance</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="text-center p-4 bg-blue-50 rounded-lg">
                            <div class="text-3xl font-bold text-blue-600">${todayStats.completions}</div>
                            <div class="text-sm text-gray-600">Tasks Completed</div>
                        </div>
                        <div class="text-center p-4 bg-green-50 rounded-lg">
                            <div class="text-3xl font-bold text-green-600">${todayStats.totalScore > 0 ? Math.round(todayStats.totalScore / todayStats.completions) : 0}</div>
                            <div class="text-sm text-gray-600">Avg Score</div>
                        </div>
                        <div class="text-center p-4 bg-purple-50 rounded-lg">
                            <div class="text-3xl font-bold text-purple-600">${todayStats.perfectScores}</div>
                            <div class="text-sm text-gray-600">Perfect Scores üíé</div>
                        </div>
                        <div class="text-center p-4 bg-orange-50 rounded-lg">
                            <div class="text-3xl font-bold text-orange-600">${Math.round(todayStats.totalTime / 60)}</div>
                            <div class="text-sm text-gray-600">Total Minutes</div>
                        </div>
                    </div>
                </div>

                <!-- Streaks & Achievements -->
                <div class="bg-white rounded-lg shadow-lg p-6 mb-4">
                    <h3 class="font-bold text-lg mb-4">üî• Streaks & Achievements</h3>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between p-3 bg-gradient-to-r from-orange-50 to-red-50 rounded-lg">
                            <div>
                                <div class="font-semibold">Current Streak</div>
                                <div class="text-xs text-gray-600">Consecutive days</div>
                            </div>
                            <div class="text-3xl font-bold text-orange-600">${currentStreak} üî•</div>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-gradient-to-r from-yellow-50 to-orange-50 rounded-lg">
                            <div>
                                <div class="font-semibold">Longest Streak</div>
                                <div class="text-xs text-gray-600">Personal best</div>
                            </div>
                            <div class="text-3xl font-bold text-yellow-600">${longestStreak} ‚≠ê</div>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg">
                            <div>
                                <div class="font-semibold">Perfect Scores</div>
                                <div class="text-xs text-gray-600">Lifetime</div>
                            </div>
                            <div class="text-3xl font-bold text-purple-600">${perfectScoreCount} üíé</div>
                        </div>
                    </div>
                </div>

                <!-- Overall Stats -->
                <div class="bg-white rounded-lg shadow-lg p-6 mb-4">
                    <h3 class="font-bold text-lg mb-4">üìà All-Time Stats</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-3 border-l-4 border-blue-500 bg-gray-50 rounded">
                            <div class="text-2xl font-bold text-gray-800">${totalCompletions}</div>
                            <div class="text-sm text-gray-600">Total Completions</div>
                        </div>
                        <div class="p-3 border-l-4 border-green-500 bg-gray-50 rounded">
                            <div class="text-2xl font-bold text-gray-800">${avgScore}</div>
                            <div class="text-sm text-gray-600">Average Score</div>
                        </div>
                        <div class="p-3 border-l-4 border-purple-500 bg-gray-50 rounded">
                            <div class="text-2xl font-bold text-gray-800">${Math.round(totalTime / 60)}</div>
                            <div class="text-sm text-gray-600">Total Minutes</div>
                        </div>
                        <div class="p-3 border-l-4 border-orange-500 bg-gray-50 rounded">
                            <div class="text-2xl font-bold text-gray-800">${Object.keys(taskBestScores).length}</div>
                            <div class="text-sm text-gray-600">Tasks Tried</div>
                        </div>
                    </div>
                </div>

                <!-- Personal Bests -->
                ${Object.keys(taskBestScores).length > 0 ? `
                <div class="bg-white rounded-lg shadow-lg p-6 mb-4">
                    <h3 class="font-bold text-lg mb-4">üèÜ Personal Bests</h3>
                    <div class="space-y-2">
                        ${Object.entries(taskBestScores).slice(0, 5).map(([taskKey, best]) => {
                            const [day, taskIndex] = taskKey.split('_');
                            const task = tasks[day][taskIndex];
                            return `
                            <div class="flex items-center justify-between p-3 bg-yellow-50 rounded-lg border border-yellow-200">
                                <div class="flex items-center gap-2">
                                    <span class="text-xl">${task.icon}</span>
                                    <div>
                                        <div class="font-semibold text-sm">${task.name}</div>
                                        <div class="text-xs text-gray-600">${best.date}</div>
                                    </div>
                                </div>
                                <div class="text-2xl font-bold text-yellow-600">${best.score}</div>
                            </div>
                            `;
                        }).join('')}
                    </div>
                </div>
                ` : ''}

                <!-- Recent History -->
                ${recentCompletions.length > 0 ? `
                <div class="bg-white rounded-lg shadow-lg p-6 mb-4">
                    <h3 class="font-bold text-lg mb-4">üìú Recent History</h3>
                    <div class="space-y-2">
                        ${recentCompletions.map(completion => `
                            <div class="p-3 bg-gray-50 rounded-lg border border-gray-200">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center gap-2">
                                        <span class="text-lg">${tasks[completion.day][completion.taskIndex].icon}</span>
                                        <div>
                                            <div class="font-semibold text-sm">${completion.taskName}</div>
                                            <div class="text-xs text-gray-600">${completion.time}</div>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-xl font-bold ${completion.score >= 90 ? 'text-green-600' : completion.score >= 75 ? 'text-blue-600' : 'text-gray-600'}">${completion.score}</div>
                                    </div>
                                </div>
                                ${completion.badges.length > 0 ? `
                                    <div class="flex gap-2 flex-wrap">
                                        ${completion.badges.map(badge => `
                                            <span class="px-2 py-1 bg-white rounded-full text-xs flex items-center gap-1 border border-gray-300">
                                                ${badge.emoji} ${badge.name}
                                            </span>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : `
                <div class="bg-white rounded-lg shadow-lg p-6 text-center">
                    <div class="text-6xl mb-4">üìä</div>
                    <h3 class="font-bold text-lg mb-2">No History Yet</h3>
                    <p class="text-gray-600">Complete some tasks to see your stats!</p>
                </div>
                `}
            `;

            statsContent.innerHTML = html;
        }

        // Debug Controls - Navbar Position Adjustment
        let navbarBottomOffset = 0;

        function toggleDebugControls() {
            const controls = document.getElementById('debugControls');
            controls.classList.toggle('hidden');
        }

        function moveNavbar(direction) {
            const navbar = document.querySelector('.mobile-bottom-nav');
            const step = 2; // Move 2px at a time

            if (direction === 'up') {
                navbarBottomOffset += step;
            } else if (direction === 'down') {
                navbarBottomOffset -= step;
            }

            // Preserve all existing styles
            navbar.style.bottom = navbarBottomOffset + 'px';
            navbar.style.position = 'fixed';
            navbar.style.left = '24px';
            navbar.style.right = '24px';
            navbar.style.borderRadius = '20px';
            navbar.style.padding = '0.5rem 0.25rem';

            updateDebugInfo();
        }

        function resetNavbar() {
            const navbar = document.querySelector('.mobile-bottom-nav');
            navbarBottomOffset = 0;
            navbar.style.bottom = '';
            navbar.style.position = '';
            navbar.style.left = '';
            navbar.style.right = '';
            navbar.style.borderRadius = '';
            navbar.style.padding = '';
            updateDebugInfo();
        }

        function updateDebugInfo() {
            const navbar = document.querySelector('.mobile-bottom-nav');
            const rect = navbar.getBoundingClientRect();
            const computedStyle = window.getComputedStyle(navbar);

            document.getElementById('debugInfo').innerHTML = `
                Bottom: ${navbarBottomOffset}px<br>
                Visible: ${computedStyle.display}<br>
                Y: ${Math.round(rect.top)}px
            `;
        }

        // Show signup form
        function showSignup() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('signupForm').classList.remove('hidden');
            document.getElementById('errorMessage').classList.add('hidden');
        }

        // Show login form
        function showLogin() {
            document.getElementById('signupForm').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('errorMessage').classList.add('hidden');
        }

        // Show error message
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        // Sign in
        async function signIn() {
            // Clear any error messages first
            document.getElementById('errorMessage').classList.add('hidden');

            // Developer/Test Mode - Bypass Firebase for local development
            // Just click Sign In to enter the app without credentials
            console.log("üîì Dev mode - bypassing authentication");
            bypassFirebaseLogin();
            return;

            // Production Firebase authentication (currently disabled for dev)
            // Uncomment below for production:
            /*
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showError('Please enter email and password');
                return;
            }

            try {
                await window.signInWithEmailAndPassword(window.auth, email, password);
            } catch (error) {
                showError(error.message);
            }
            */
        }

        // Bypass Firebase login for development/testing
        function bypassFirebaseLogin() {
            // Hide login, show app
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainAppContainer').classList.remove('hidden');
            document.body.classList.add('app-active');

            // Set mock user data
            const mockName = "Developer";
            const mockEmail = "dev@test.local";
            document.getElementById('userName').textContent = mockName;
            document.getElementById('profileName').value = mockName;
            document.getElementById('profileEmail').value = mockEmail;

            console.log("‚úÖ Bypassed Firebase - Developer mode active");
        }

        // Sign up
        async function signUp() {
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;

            if (!name || !email || !password) {
                showError('Please fill in all fields');
                return;
            }

            if (password.length < 6) {
                showError('Password must be at least 6 characters');
                return;
            }

            try {
                const userCredential = await window.createUserWithEmailAndPassword(window.auth, email, password);

                // Update profile with display name
                await window.updateProfile(userCredential.user, {
                    displayName: name
                });

                // Save user data to Firestore
                await window.setDoc(window.doc(window.db, 'users', userCredential.user.uid), {
                    displayName: name,
                    email: email,
                    createdAt: new Date().toISOString()
                });
            } catch (error) {
                showError(error.message);
            }
        }

        // Save profile
        async function saveProfile() {
            const name = document.getElementById('profileName').value;

            if (!name) {
                alert('Please enter a name');
                return;
            }

            try {
                const user = window.auth.currentUser;
                await window.updateProfile(user, { displayName: name });
                await window.setDoc(window.doc(window.db, 'users', user.uid), {
                    displayName: name,
                    email: user.email,
                    updatedAt: new Date().toISOString()
                }, { merge: true });

                document.getElementById('userName').textContent = name;
                alert('Profile updated successfully!');
            } catch (error) {
                alert('Error updating profile: ' + error.message);
            }
        }

        // Logout
        async function logout() {
            if (confirm('Are you sure you want to logout?')) {
                try {
                    await window.signOut(window.auth);
                } catch (error) {
                    alert('Error signing out: ' + error.message);
                }
            }
        }

        // Theme Management
        function changeTheme(themeName) {
            // Remove all theme classes
            document.body.className = document.body.className
                .split(' ')
                .filter(c => !c.startsWith('theme-'))
                .join(' ');

            // Add new theme
            document.body.classList.add(themeName);

            // Update checkmarks and styling
            document.querySelectorAll('[id$="-btn"]').forEach(btn => {
                const checkmark = btn.querySelector('.checkmark');
                if (checkmark) checkmark.remove();
                // Remove theme-selected class
                btn.classList.remove('theme-selected');
                // Reset border
                const circle = btn.querySelector('div');
                if (circle) circle.style.border = '3px solid #e5e7eb';
            });

            const selectedBtn = document.getElementById(themeName + '-btn');
            if (selectedBtn) {
                // Add checkmark
                const checkmark = document.createElement('div');
                checkmark.className = 'checkmark absolute inset-0 flex items-center justify-center';
                checkmark.innerHTML = '<span class="text-lg text-white" style="text-shadow: 0 1px 2px rgba(0,0,0,0.5);">‚úì</span>';
                selectedBtn.appendChild(checkmark);

                // Add theme-selected class
                selectedBtn.classList.add('theme-selected');
            }

            // Save to localStorage
            localStorage.setItem('appTheme', themeName);

            console.log('üé® Theme changed to:', themeName);
        }

        // Notifications Toggle
        function toggleNotifications(enabled) {
            console.log('Notifications:', enabled ? 'enabled' : 'disabled');
            localStorage.setItem('notificationsEnabled', enabled);
            // Add actual notification logic here
        }

        // Dark Mode Toggle
        function toggleDarkMode(enabled) {
            if (enabled) {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
            localStorage.setItem('darkMode', enabled);
            console.log('Dark mode:', enabled ? 'enabled' : 'disabled');
        }

        // Initialize settings on load
        function initializeSettings() {
            // Load saved theme
            const savedTheme = localStorage.getItem('appTheme') || 'theme-default';
            changeTheme(savedTheme);

            // Load notifications setting
            const notifEnabled = localStorage.getItem('notificationsEnabled') === 'true';
            const notifToggle = document.getElementById('notificationsToggle');
            if (notifToggle) notifToggle.checked = notifEnabled;

            // Load dark mode setting
            const darkModeEnabled = localStorage.getItem('darkMode') === 'true';
            const darkToggle = document.getElementById('darkModeToggle');
            if (darkToggle) darkToggle.checked = darkModeEnabled;
            if (darkModeEnabled) document.body.classList.add('dark-mode');

            // Update profile display
            const profileDisplayName = document.getElementById('profileDisplayName');
            const profileDisplayEmail = document.getElementById('profileDisplayEmail');
            const profileName = document.getElementById('profileName');
            const profileEmail = document.getElementById('profileEmail');

            if (profileDisplayName && profileName) {
                profileDisplayName.textContent = profileName.value || 'Developer';
            }
            if (profileDisplayEmail && profileEmail) {
                profileDisplayEmail.textContent = profileEmail.value || 'dev@test.local';
            }
        }

        // Handle enter key on login and initialize settings
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('loginEmail')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') signIn();
            });
            document.getElementById('loginPassword')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') signIn();
            });
            document.getElementById('signupPassword')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') signUp();
            });

            // Initialize settings
            initializeSettings();
        });
    </script>

</body>
</html>
